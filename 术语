
ESDP背景介绍
ESDP系统-软件授权和License管理平台
ESDP系统主要工作流程是通过上游ERP系统的订单导入，生成授权，之后绑定网元（设备），激活生成License文件。
授权是供应商与客户对所销售/购买产品的使用范围、功能、期限等进行授权/被授权的一种合约形式。供应商卖的不是软件所有权，而是软件的使用权。
License又称软件授权许可证，是供应商与客户对所销售/购买的产品使用范围、期限等进行授权/被授权的一种合约形式，通过License，客户同时也获得供应商所承诺的相应服务。物理形式上表现为License授权证书和License文件。 
  是软件销售的一种方式，按照特性、版本、容量和使用时间等方式进行使用授权，客户获得设备商所承诺的相应权利和License授权证书。卖的不是软件所有权，而是软件的使用权。


授权版本号变更

- 使用场景：交付的产品版本和合同中签订的版本号不一致时，可以使用该功能进行调整。
- 业务规则：
  1. 只能对转售的大小S产品使用该功能；
  2. 只能对授权状态为ready的授权使用该功能；
  3. 操作执行成功，会根据产品、调整后的版本等信息重新执行大小S拆分算法，生成新的授权行；同时删除原授权行。



推送资源池

- 使用场景：可以将授权推入资源池，激活时再根据现网情况，分配到设备（网元）上。
- 业务规则：
  1. 授权的类型需要资源池的类型一致；
  2. 授权的到期时间需要和资源池的到期时间一致。

分组

- 使用场景：授权分组后，可以基于分组进行激活、推送资源池等操作。
- 分组规则：同客户、同产品、同版本、同授权类型、同Part编码、每一项Part到期日期相同、每一项Part总量相同以及Part个数相同。

激活业务说明

激活的业务范围

    a)  凡是将客户购买的资源与客户网元设备按照销售策略进行绑定，并通过加密算法生成一个控制设备服务时长的License授权文件的过程，都属于激活业务。
    
    b)  根据销售方式的不同，授权分为年费授权和非年费授权；不同授权激活时，校验上会有不同；年费授权会有关于年费时间的计算规则和校验规则。
    
    c)  根据BG类型的不同，分为企业网和运营商授权，企业网不校验网元客户名称和授权客户名称,运营商客户要校验。

非年费授权激活

非年费激活分为：新建激活，升级激活，扩容激活。

a) 新建激活，指绑定的ESN上没有激活过授权；

    校验：客户+名称+产品+ESN唯一性，不唯一时生成新的名称的ESN；

b) 升级激活，表示一个已被激活过的网元，进行一次版本升级操作，该次操作在产品配置项里，需要能找到该升级产品的升级路径，升级成功后版本将升级到指定版本。

    校验： 
    
    1）客户+产品+ESN一致性，不一致不允许激活；
    2）升级路径、升级算法、升级项，不存在时，不允许激活；

c) 扩容激活，表示一个已被激活过的网元，进行一次扩容操作，包括part项增加，bom量的增加，都为扩容激活。

    校验：客户+产品+ESN一致性。

年费授权激活

年费激活分为：首签激活，扩容激活，续签激活，升级激活，版本变更。

a) 首签激活，指含有年费商业模式的授权第一次交付到网元的场景。

    校验：
    
    1）客户+名称+产品+ESN唯一性，不唯一时生成新的名称的ESN，
    
    2）网元上是否存在年费服务时间，不为空时不允许激活（通用算法限制）
    
    3）年费时间算法不为空。

b) 扩容激活，指一个已被激活过的网元，进行一次扩容操作，包括part项增加，bom量的增加，都为扩容激活。

    校验：
    
    1）校验客户+产品+ESN一致性，不一致不允许激活；
    
    2）网元上是否存在年费服务时间，为空时不允许激活，（首签起算规则为PAC、POD、PO签订除外）；
    
    3）年费时间算法。

c) 续签激活，指一个已被激活过的网元，合同只续签服务时长，不再买普通特性项，这种场景就是续签

    校验：
    
    1）校验客户+产品+ESN一致性，不一致不允许激活；
    
    2）网元上是否存在年费服务时间，为空时不允许激活，（首签起算规则为PAC、POD、PO签订除外）；
    
    3）年费时间算法。

d) 升级激活，指同版本横向升级场景，产品通过激活升级项，达到特性服务升级，但产品VR版本不发生变化的目的。

    校验：
    
    1）校验客户+产品+ESN一致性，不一致不允许激活；
    
    2）网元上是否存在年费服务时间，为空时不允许激活，（起算规则为PAC、POD、PO签订除外）；
    
    3）年费时间算法；
    
    4）同版本间升级算法。

e) 版本变更，指年费VR版本间的升级，在年费有效期内，产品可按照对应的升级或降级路径通过版本变更方式，进行产品VR版本的升级或降级

    校验：
    
    1）校验客户+产品+ESN一致性，不一致不允许激活；
    
    2）年费服务时间是否到期，到期后不允许进行版本变更操作；
    
    3）版本间升级路径、算法。

池化license

- 使用场景：
  1、目前只支持订阅模式的池化；
  2、License中心通过池化流程，把各产品的软件授权推入ESDP上客户资源池中，从客户资源池导出池化License数据包，数据包中包含了资源池中License资源总量信息；
  3、池化License文件与Cloud License的ESN绑定，客户可根据需要进行分配和回收。
- 业务规则：授权上有池化标识才能使用池化功能进行激活。

激活策略管理

激活策略是通过项目、合同号、BOQ、产品、城市等查询条件，检索出变革项目试点合同未交付的资源，以BOQ+产品+版本维度引入激活策略，并对BOQ设置扣减优先级。在使用激活策略激活时，按照预先设置的BOQ扣减顺序依次扣减Bpart可用量的激活方式。

商业永久激活策略除可使用试点合同的BOQ资源外，还可以引入存量的资源池，并对资源池和BOQ一起设置扣减优先级。

固定期限激活策略只能添加资源池，并对资源池设置扣减优先级，激活扣减时，按照预先设置的资源池扣减顺序依次扣减Bpart可用量的激活方式。

注：以上策略激活成功后，会记录网元交付流水；BOQ扣减记录会更新到授权台账。

设备（网元）调整
使用场景： 由于合同签订时无法准确将License分到每个网元，导致合同签订时的计划配置与工程安装时的实际配置不符合，需要在工程初验前进行网元间License调整。

业务规则：

PAC前需要输入失效码，PAC后不需要失效码，但是需要审批；

可以将设备（网元）的存量调整至任意同产品、同版本的其它设备网元上。

设备（网元）合并
使用场景：设备（网元）合并，是设备（网元）调整操作模式的一个细分场景，相较于后者，前者在合并两个设备网元的License时，不用调整BOM变化量，操作更加高效便捷，但不支持对空设备网元进行操作，也不支持选择资源池操作、离线操作。

业务规则：

网页选择网元的总数量最少是2个，最多不超过50个；

选择的激活网元，状态默认限定为Activated；

可创建或选择空设备网元，空设备网元状态为Ready；

调整前后的BOM总容量必须保持一致。

设备（网元）拆分
使用场景： 设备（网元）拆分，是设备（网元）调整操作模式的一个细分场景，相较于后者，前者不支持对空设备网元进行拆分操作，也不支持选择资源池操作、离线操作。

业务规则：被拆分的网元只能选择激活状态的设备网元（Activated），每次申请只能选择1个；拆分至的网元只能选择空网元（Ready），最少选择1个，最多不超过499个。

固定期限license申请
使用场景：固定期限有九种类型的固定期限，适用于不同场景的使用。

1.软件试用

软件试用是一种软件促销方式，即在客户购买之前给客户试用一段时间新特性，向客户展示试用软件带来的价值，默认到期时间：6个月

2.软件测试

已转商用的站点，不允许申请软件测试的license，默认到期时间：1年

3.Beta实验局

只限于研发在研版本TR5之后的beta试验局业务场景，此流程需要校验合同号，只有尾号为8X类试验局借货合同方可走此流程申请对应的license，默认到期时间：180天

4.展览展示

由华为为发起主体或自主参加的大型品牌活动，如：展会、现场会、论坛、用户大会、展车等公司品牌类的活动的LICENSE申请，对应于７X 展览展示类硬件借货，默认到期时间：1年

5.软件订购年费SUS

针对软件版本升级及指定范围的可选特性，客户按年支付软件使用费，获得软件使用权的交易模式。该协议期一般在3-5年。客户在协议到期后，需要续签协议，以持续获得软件使用权。默认到期时间：1年

6.后付费

运营商为规避运营风险，要求设备商先开放超过购买量甚至是开放设备最大能力的License，然后在每一固定周期（例如每季度、每半年）双方对网络实际使用的License进行统计、审计，再根据统计、审计达成一致的License相关业务经营和运营结果，对License进行付费。后付费项目特指此类华为先交付License给客户使用、客户再根据使用统计结果进行付费的PAYG、PAYU、RS等商业解决方案类项目；默认到期时间：1年

7.调测转固定期限

工程调测完成后，调测License应转为加载永久商用License；如果出现商用订单的License授权量不足的情形，作为过渡可以通过此流程申请不足部分的固定期限License。默认到期时间：180天

8.非典型

PO延迟、预算不足、客户网络KPI指标比拼、现网临时License清理(超出合同范围的)，系统定期会统计地区部/代表处的申请金额，对于申请金额超标的地区部/代表处要向BG总裁汇报。默认到期时间：180天

9.节能服务

为支撑PowerStar节能方案统一由服务上市，并落地PAYS（分成模式）商业模式，需要有节能固定期限license支撑，默认到期时间：1年

业务规则：

固定期限生成的授权，没有的激活的情况下，同样可以推入资源池进行管理，只要固定期限的license的截止日期相同。


匹配子任务交互
子任务调度-->通过子任务查询匹配数据
子任务调度-->通过子任务id查询匹配数据--> 封装增量:授权及编码信息--> 封装存量(查询网元存量)

--> 校验存量与增量数据, 客户是否一致--> 一致则调用匹配合并--> 校验网元信息规则是否满足--> 调用产品算法合并接口-->封装网元信息及license信息-->组装license文件内容-->校验匹配是否成功--> 保存匹配数据到匹配表--> 更新匹配结果为成功



激活子任务交付

通过子任务id查询匹配结果数据-->调用签名保存数据-->调用算法kms进行签名-->保存签名结果数据到临时表-->封装授权台账扣减请求mq --> 返回执行结果--> 成功 则匹配任务数据状态设置为挂起

扣减回调mq消费-->查询匹配记录数据--> 调用扣减回调处理实现-->扣减成功则 查询匹配结果临时数据 --> 进行网元激活保存数据 -->更新匹配结果为成功,并返回 --> 授权扣减回调结果是否成功 --> 是 则发送回调处理结果mq通知--> 发送子任务执行结果mq通知给任务 --> 消费mq执行结束

LRN退货--资源池退货, 网元退货, BOQ退货
授权查询--激活, 授权行分组, 第三方license下载, 推入资源池, 授权行拆分, 导出授权行
授权维度--授权证书下载, 授权拆分, 授权分发回退
网元管理--批量网元解锁, 批量合并license, 下载license, 导出, 新增
策略激活--激活策略管理, 策略详情, 在线策略激活, 台账管理, 网元交付流水
license调测与维护--失效license找回, license刷新, esn变更, 离线网元调整, 版本变更, license文件对比
